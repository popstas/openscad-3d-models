# Инструкции для агента по проекту OpenSCAD 3D моделей

## Обзор проекта
Этот репозиторий содержит коллекцию 3D моделей, созданных в OpenSCAD. Каждая модель представляет собой параметрическую конструкцию, оптимизированную для 3D печати.

## Структура проекта

### Организация файлов
- **Одна модель на папку**: `YYYY-MM-DD-short-slug/` (например, `2025-08-24-ecig-platform`)
- **Основной файл**: один `kebab-case.scad` файл на папку
- **Экспорт**: опциональные `.stl` файлы (и изображения) рядом с `.scad` в той же папке
- **Локальные ресурсы**: все ресурсы хранятся локально в папке модели; избегать импортов между папками

Перед созданием новой модели смотри README других моделей, выбери 2-3 модели для изучения, чтобы сделать по аналогии.

В начале создай README.md модели, опиши все фрагменты.
Потом создай scad файл модели.

Add variable `description = "";` in the top of scad file.
Write one line short description to var.

### Команды сборки и разработки
- **Предварительный просмотр в GUI**: `openscad 2025-08-24-ecig-platform/ecig-platform.scad`
- **Экспорт STL**: `openscad -o 2025-08-24-ecig-platform/ecig-platform.stl 2025-08-24-ecig-platform/ecig-platform.scad`
- **Переопределение параметров**: `openscad -D wall=2.2 -o out.stl path/to/model.scad`
- **Компиляция (CGAL) в GUI**: F6 для выявления ошибок геометрии перед экспортом

## Стандарты кодирования

### Отступы и именование
- **Отступы**: 2 пробела; без табуляции
- **Именование переменных**: `snake_case` для переменных/модулей; `UPPER_SNAKE` для констант
- **Именование файлов**: `kebab-case.scad` соответствует slug папки
- **Единицы измерения**: миллиметры; именовать переменные с единицами при необходимости (например, `wall_mm`)

## Структура модели

### Параметры модели
- **Версия модели**: `1.0`
- **Переменные**: описывают все размеры модели
- **Комментарии**: описание работы модели, список фрагментов модели
- **Функции фрагментов детали**: каждый фрагмент детали должен быть в отдельной функции
- **Функция вывода всех фрагментов**: выводит все фрагменты детали
- **Функция обрезки через intersection**: если указан test_fragment

don't make inline modules, all modules should be at the top scope.

### Структура кода
- **Точка входа**: предпочитать `module main()` как точку входа и вызывать `main();` в конце
- **Вспомогательные модули**: держать выше или в отдельном `*-lib.scad` в той же папке
- **Документирование**: комментировать параметры верхнего уровня с краткими описаниями и разумными значениями по умолчанию

## Обязательные параметры точности

```scad
// ===== Точность аппроксимации окружностей =====
$fn = 0;        // фиксированную сегментацию отключаем
$fa = 6;        // 5–8° обычно достаточно
$fs = 0.35;     // ≈ диаметр сопла (0.3–0.5 для сопла 0.4)
pin_fs = 0.25;  // чуть тоньше для штырей и отверстий
```

## Обязательные служебные параметры

```scad
// ===== Режим печати тест‑фрагментов =====
test_fragment = false;   // true — печатать только угловые фрагменты
frag_size     = 20;     // размер квадрата вырезки, мм
frag_index    = 0;      // 0=НЛ, 1=ВЛ, 2=НП, 3=ВП (относительно основания)
frag_gap_x    = 10;     // зазор между фрагментами по X, мм
frag_h_extra  = 20;     // запас по высоте клипа, мм

// ===== Общие доп. параметры =====
tiny = 0.1;                  // небольшой зазор для булевых операций
edge_chamfer_z = 1;       // высота фаски по Z (мм)
edge_chamfer_x = 5;       // горизонтальный вылет фаски по X (с каждой стороны), мм
edge_chamfer_y = 5;       // горизонтальный вылет фаски по Y (с каждой стороны), мм
screen_frame_gap = 0.2;      // только для высоты вычитаний в рамке (не влияет на XY)
```

## Структура файла модели

### 1. Заголовок и версия
```scad
// OpenSCAD: описание модели
// Версия: v1.0 — краткое описание изменений
```

### 2. Параметры точности (обязательно)
```scad
// ===== Точность аппроксимации окружностей =====
$fn = 0;        // фиксированную сегментацию отключаем
$fa = 6;        // 5–8° обычно достаточно
$fs = 0.35;     // ≈ диаметр сопла (0.3–0.5 для сопла 0.4)
pin_fs = 0.25;  // чуть тоньше для штырей и отверстий
```

### 3. Служебные параметры (обязательно)
```scad
// ===== Режим печати тест‑фрагментов =====
test_fragment = false;   // true — печатать только угловые фрагменты
frag_size     = 20;     // размер квадрата вырезки, мм
frag_index    = 0;      // 0=НЛ, 1=ВЛ, 2=НП, 3=ВП
frag_gap_x    = 10;     // зазор между фрагментами по X, мм
frag_h_extra  = 20;     // запас по высоте клипа, мм

// ===== Общие доп. параметры =====
tiny = 0.1;                  // небольшой зазор для булевых операций
edge_chamfer_z = 1;       // высота фаски по Z (мм)
edge_chamfer_x = 5;       // горизонтальный вылет фаски по X, мм
edge_chamfer_y = 5;       // горизонтальный вылет фаски по Y, мм
screen_frame_gap = 0.2;      // только для высоты вычитаний
```

### 4. Переменные модели
```scad
// ===== Параметры модели =====
// Все размеры модели в переменных
model_length = 100;          // длина модели, мм
model_width  = 50;           // ширина модели, мм
model_height = 20;           // высота модели, мм
```

### 5. Комментарии и описание
```scad
// ===== Комментарии ===========================
/*
Модель: краткое описание назначения
Блоки:
- Переменные (вверху) для всех размеров
- Комментарии (этот блок)
- Функции фрагментов детали (ниже)
- Функция вывода всех фрагментов show_all()
- Функция обрезки через intersection при test_fragment=true

Детали: base (главная деталь), front, frame и т.п.
План: описание конструкции
*/
```

### 6. Вспомогательные функции
```scad
// ===== Вспомогательные функции ====================
function clamp(val, lo, hi) = max(lo, min(val, hi));
// Другие вспомогательные функции
```

### 7. Модули деталей
```scad
// ===== Модули деталей ====================
module base() {
    // Основная деталь
}

module front() {
    // Передняя деталь
}

module frame() {
    // Рамка
}
```

### 8. Функция вывода всех фрагментов
```scad
// ===== Вывод всех фрагментов ====================
module show_all() {
    if (test_fragment) {
        // Режим тест-фрагментов
        intersection() {
            union() {
                base();
                front();
                frame();
            }
            // Логика вырезки фрагментов
        }
    } else {
        // Полный рендер
        base();
        front();
        frame();
    }
}
```

### 9. Точка входа
```scad
// ===== Точка входа ====================
show_all();
```

## Рекомендации по проектированию

### Параметрическое проектирование
- Все критические размеры должны быть переменными в начале файла
- Использовать осмысленные имена переменных с единицами измерения
- Группировать связанные параметры в секции

### Точность для разных элементов
```scad
// Для штырей и отверстий использовать повышенную точность
cylinder(h=..., d=d, $fs=pin_fs, $fa=6);
cylinder(h=..., d1=d, d2=max(d-0.6,0.5), $fs=pin_fs, $fa=6);
```

### Фаски и скругления
- Предусматривать настройку фасок и скруглений по краям модели
- Использовать параметры `edge_chamfer_*` для унификации
- Создавать модули для типовых операций с фасками

### Тестирование
- **Визуальные проверки**: F5 для быстрого предварительного просмотра, F6 для компиляции и проверки валидности
- **Проверки размеров**: проверять ключевые зазоры и общий размер относительно реальных деталей
- **Печатаемость**: экспортировать при Z=0, вертикальная ориентация, только замкнутые тела
- **Тест-фрагменты**: использовать для быстрого тестирования посадки

## Рекомендации по коммитам и PR

### Коммиты
- **Формат**: императив, с указанием папки модели
- **Пример**: `ecig-platform: increase battery bay clearance +0.4mm`
- **Содержание**: что/почему и упоминание скорректированных параметров

### Pull Request
- Связывать с соответствующими issues (если есть)
- Включать скриншоты до/после или заметки о различиях STL
- Перечислять ключевые размеры/зазоры
- Отмечать результаты печати (материал, высота слоя, посадка)
- Минимизировать сгенерированные файлы; коммитить STL только для стабильных релизов/вариантов

## Полезные приёмы OpenSCAD

### 1. Массивы позиций для повторяющихся элементов
```scad
hole_positions = [
    [edge_x, edge_y],                    // нижний левый
    [edge_x, base_width - edge_y],       // верхний левый
    [base_length - edge_x, edge_y],      // нижний правый
    [base_length - edge_x, base_width - edge_y]  // верхний правый
];
```

### 2. Функции ограничения значений
```scad
function clamp(val, lo, hi) = max(lo, min(val, hi));
function clamp_chz(t, chz) = clamp(chz, 0, t/2);
```

### 3. Условный рендеринг
```scad
if (test_fragment) {
    // Рендер фрагментов для тестирования
} else {
    // Рендер полных деталей
}
```

### 4. Отладочный вывод
```scad
echo("Margins to edges (L,R,B,T):", left_margin, right_margin, bottom_margin, top_margin);
```

### 5. Цветовое кодирование деталей
```scad
color("lightgray") base();
color("silver") frame();
```

## Изучение существующих моделей

Каждая модель в репозитории содержит README.md с описанием полезных приёмов OpenSCAD. Изучайте эти файлы для понимания лучших практик:

- `2025-08-24-display-case-sunton-5/README.md` - приёмы параметрического проектирования
- `2025-08-24-ecig-platform/README.md` - приёмы работы с формами и посадками

Эти инструкции обеспечивают единообразие в разработке 3D моделей и помогают создавать качественные, параметрические конструкции, оптимизированные для 3D печати.